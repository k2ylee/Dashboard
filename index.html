import pandas as pd
import json
import os

def process_sales_data(main_file_path):
    """
    處理新品銷售數據並生成 Dashboard 所需的 JSON 結構
    """
    print(f"正在讀取檔案: {main_file_path}...")
    
    # 讀取 CSV，header=1 因為原始 Excel 轉出的 CSV 第二行才是標題
    try:
        df = pd.read_csv(main_file_path, header=1)
    except Exception as e:
        return {"error": f"讀取檔案失敗: {str(e)}"}

    # --- 1. 資料清洗 ---
    # 去除 '品名' 為空或包含 '合計' 的列
    df_clean = df[df['品名'].notna() & ~df['品名'].astype(str).str.contains('合計')]
    
    # 轉換數值欄位 (處理可能包含逗號或非數值字元的情況)
    df_clean['銷貨淨額'] = pd.to_numeric(df_clean['銷貨淨額'], errors='coerce').fillna(0)
    df_clean['淨銷貨(KG)'] = pd.to_numeric(df_clean['淨銷貨(KG)'], errors='coerce').fillna(0)

    # --- 2. KPI 計算 ---
    total_sales = float(df_clean['銷貨淨額'].sum())
    total_kg = float(df_clean['淨銷貨(KG)'].sum())
    total_skus = int(df_clean['料號'].nunique())
    
    # --- 3. 排行榜分析 (Top Products) ---
    top_products = df_clean.groupby(['料號', '品名'])['銷貨淨額'].sum() \
        .sort_values(ascending=False).head(20).reset_index()
    
    top_products_list = []
    for _, row in top_products.iterrows():
        top_products_list.append({
            "id": row['料號'],
            "name": row['品名'],
            "revenue": float(row['銷貨淨額'])
        })

    # --- 4. 開發效率分析 (Department Efficiency) ---
    # 這是使用者要求的重點：開發數量 vs 業績貢獻
    dept_stats = df_clean.groupby('歸屬部門').agg({
        '銷貨淨額': 'sum',
        '料號': 'nunique' # 計算該部門開發/銷售了多少支新品
    }).reset_index()
    
    dept_stats.columns = ['name', 'revenue', 'sku_count']
    
    # 計算平均單品貢獻 (效率指標)
    dept_stats['efficiency'] = dept_stats['revenue'] / dept_stats['sku_count']
    
    dept_stats_list = dept_stats.to_dict(orient='records')

    # --- 5. 客戶貢獻度 (Top Customers) ---
    top_customers = df_clean.groupby('客戶名稱')['銷貨淨額'].sum() \
        .sort_values(ascending=False).head(10).reset_index()
        
    top_customers_list = top_customers.to_dict(orient='records')
    
    # --- 6. 組合最終輸出 ---
    dashboard_data = {
        "period": "2025-01 ~ 2025-11",
        "kpi": {
            "total_sales": total_sales,
            "total_kg": total_kg,
            "total_skus": total_skus,
            "avg_revenue_per_sku": total_sales / total_skus if total_skus > 0 else 0
        },
        "top_products": top_products_list,
        "efficiency_matrix": dept_stats_list, # 用於散佈圖
        "top_customers": top_customers_list
    }

    return dashboard_data

if __name__ == "__main__":
    # 使用範例檔名，請確保檔案在同一目錄下
    file_name = '2025年1~11月新品售統計.xlsx - 新品業績.csv'
    
    if os.path.exists(file_name):
        data = process_sales_data(file_name)
        
        # 輸出成 JSON 檔案
        with open('dashboard_data.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
            
        print("分析完成！數據已輸出至 'dashboard_data.json'")
        print(f"總銷售額: {data['kpi']['total_sales']:,.0f}")
    else:
        print(f"找不到檔案: {file_name}，請確認檔名與路徑。")